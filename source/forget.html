<!DOCTYPE html>
<html>
  <head>
  
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Projet EBO-SURSY</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="all,follow">
    
    <!-- Bootstrap CSS-->
    <link rel="stylesheet" href="vendor/bootstrap/css/bootstrap.min.css">
    <!-- Font Awesome CSS-->
    <link rel="stylesheet" href="vendor/font-awesome/css/font-awesome.min.css">
    <!-- Fontastic Custom icon font-->
    <link rel="stylesheet" href="css/fontastic.css">
    <!-- Google fonts - Poppins -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins:300,400,700">
    <!-- Ladda-->
    <link rel="stylesheet" href="vendor/ladda/ladda-themeless.min.css">
    <!-- theme stylesheet-->
    <link rel="stylesheet" href="css/style.default.premium.css" id="theme-stylesheet">
    <!-- Custom stylesheet - for your changes-->
    <!-- <link rel="stylesheet" href="css/custom.css"> -->
    
    <link rel="stylesheet" href="css/offline_online.css">
    
    <!-- Favicon-->
    <link rel="shortcut icon" href="img/favicon.ico">
    <!-- Tweaks for older IEs--><!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]-->
        
    <script src="vendor/jquery/jquery.min.js" onload="window.$ = window.jQuery = module.exports;"></script>
	<script>
		delete window.module;
	</script>
	
	<!-- Javascript files-->    
    <!-- <script src="vendor/popper.js/umd/popper.min.js"> </script>
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="vendor/jquery.cookie/jquery.cookie.js"> </script>
    <script src="vendor/chart.js/Chart.min.js"></script>
    <script src="vendor/jquery-validation/jquery.validate.min.js"></script> -->
    
    <!-- Loading buttons-->
    <script src="vendor/ladda/spin.min.js"></script>
    <script src="vendor/ladda/ladda.min.js"></script>
    <script src="js/components-ladda.js"></script>
    
    <script src="js/pouchdb-6.4.2.min.js"></script>
    <script src="js/pouchdb.find.js"></script> 
	
	<script src="js/load-page.js"></script>
	
	<script src="js/function.js"></script>
    
    <script src="js/send-change-password-mail.js"></script>

  </head>
  <body onload="loaded()">
  
    <script type="text/javascript">
    	showAlertFlash();
    	showErrors();     	
    </script>
      
    <div class="page login-page">
      <div class="container d-flex align-items-center">
      	<div class="form-holder has-shadow">
          <div class="row">
            <!-- Logo & Information Panel-->
            <div class="col-lg-6">
              <div class="info d-flex align-items-center">
                <div class="content">
                  <div class="logo">
                    <div class="card-group">
            		  <div class="card">
            		    <img src="logos/logos_instituts.png" class="card-img-top"/>
            		  </div>
            		  <div class="card">
            			<img src="logos/ebo-sursy_logo.jpg" class="card-img-top"/>
            		  </div>
            		</div>
            		<h1>Projet EBO-SURSY</h1>
                  </div>
                  <p>Renforcement des capacités et surveillance de la maladie à virus Ebola.</p>
                </div>
              </div>
            </div>
            <!-- Form Panel    -->
            <div class="col-lg-6 bg-white">
              <div class="form d-flex align-items-center">
                <div class="content">
                  <form id="forget-form" class="needs-validation" method="post" novalidate>
                    <div class="row">
                      <div class="led-box">
	    			    <div id="led"></div>
	    			    <p id="p_led"></p>
	    			  </div>
	                </div>
                    <div class="form-group">
                      <label for="register-email">Adresse e-mail</label>
                      <input type="email" class="form-control" id="register-email" placeholder="Adresse e-mail" required>
                      <div class="invalid-feedback">
                        S'il vous plaît fournir une adresse e-mail valide !
      				  </div>
                    </div>
                    <!--<input id="forget" name="submit" type="submit" value="Reinitialiser le mot de passe" class="btn btn-primary">-->
                    <button id="forget" name="submit" type="submit" class="btn btn-primary ladda-button" data-style="expand-right">
						<span class="ladda-label">Réinitialiser le mot de passe</span>
            			<span class="ladda-spinner"></span>
					</button>
                    <!-- This should be submit button but I replaced it with <a> for demo purposes-->
                  </form><a href="login.html" class="signup">Revenir à la page de connexion</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="copyrights text-center">
        <p>Conçu par Bruno Rosset - Cirad</p>
        <!-- Please do not remove the backlink to us unless you support further theme's development at https://bootstrapious.com/donate. It is part of the license conditions. Thank you for understanding :)-->
      </div>
    </div>
    
    <script type="text/javascript">
    
 // Example starter JavaScript for disabling form submissions if there are invalid fields
  		(function() {
  		  'use strict';
  		  window.addEventListener('load', function() {
  		    // Fetch all the forms we want to apply custom Bootstrap validation styles to
  		    var forms = document.getElementsByClassName('needs-validation');
  		    // Loop over them and prevent submission
  		    var validation = Array.prototype.filter.call(forms, function(form) {
  		      form.addEventListener('submit', function(event) {
  		        if (form.checkValidity() === false) {
  		          event.preventDefault();
  		          event.stopPropagation();
  		        } else {
  		          event.preventDefault();
  		          forget();
  		        } 		        
  		        form.classList.add('was-validated');
  		      }, false);
  		    });
  		  }, false);
  		})();

 
  		function forget() { 		
 
		/*$(document).ready(function () {
		    $("#login-form").submit(function(event) {
		    	
		    	event.preventDefault();
		    	
		    	//var errors = new Array();
			    //localStorage.removeItem('errors');
			    //removeErrors();  */
			    
				if (navigator.onLine == true) {
					
					// Create a new instance of ladda for the specified button
					var l = Ladda.create( document.querySelector( '.ladda-button' ) );

					// Start loading
					l.start();
					
					var email = document.getElementById('register-email').value;
			    	
					var remote_couchdb = localStorage.getItem('remote_couchdb');
					var remoteDB = new PouchDB(remote_couchdb + 'username', {skip_setup: true});
									    
				    remoteDB.find({
				    	selector: {email: email},
				    	fields: ['_id', 'username', 'email', 'password', 'confirmation_token', 'confirmed_at',
			  		  	         'reset_token', 'reset_at', 'remember_token']
				    }).then(function (result) {
				    	if (typeof(JSON.stringify(result.docs[0])) != "undefined"){
				    		if (result.docs[0].email == email){
				    			var reset_token = str_random(60);
				    			
				    			var remoteDB2 = new PouchDB(remote_couchdb + 'username', {skip_setup: true});
								 	
								remoteDB2.get(result.docs[0]._id).then(function (doc) {
								    doc._id = result.docs[0]._id,
							  	    doc.username = result.docs[0].username,
							  	    doc.email = result.docs[0].email,
							  	    doc.password = result.docs[0].password,
							  	    doc.confirmation_token = '',
								    doc.confirmed_at = '',
							  	    doc.reset_token = reset_token,
							  	    doc.reset_at = '',
							  	    doc.remember_token = '';	
									return remoteDB2.put(doc);					
							    }).then(function () {
								    return remoteDB2.get(result.docs[0]._id);
							    });			
								  
								
								var localDB = new PouchDB('username');
								localDB.sync(remoteDB2).on('complete', (info) => {              
							    	localDB.sync(remoteDB2, {
										live: true,
									  	retry: true
									}); //Continous sync with options
									sendMail(result.docs[0]._id, reset_token, email, msgValidate);
									l.stop();
							    });
								
				    		}	
						    
				    	}
				    });
				    
				    
				    
				} else {
					//errors.push("Vous devez être en ligne pour changer votre mot de passe !");
					//localStorage.setItem('errors', JSON.stringify(errors));
				    addErrors("Vous devez être en ligne pour changer votre mot de passe !");
					window.location.reload();			
				} 
		}	    
		    /*});
		
		});*/
	</script> 
	
	<script type="text/javascript">
		document.addEventListener("keydown", function(event) {
			if (event.keyCode == 13) {
		    	event.preventDefault();
		    	return false;
		  	}
		}, true); // "true" => phase de capture
     </script> 
    
  </body>
</html>